name: wekan-ondra
version: "0.X-ci"
summary: The open-source Trello-like kanban
description: |
   Wekan is an open-source and collaborative kanban board application.

   Whether youâ€™re maintaining a personal todo list, planning your holidays with some friends, or working in a team on your next revolutionary idea, Kanban boards are an unbeatable tool to keep your things organized. They give you a visual overview of the current state of your project, and make you productive by allowing you to focus on the few items that matter the most.
   Depending on target environment, some configuration settings might need to be adjusted.
   For full list of configuration options call:
   $ wekan-ondra.help

confinement: strict
grade: stable

apps:
    wekan:
        command: wekan-control
        daemon: simple
        plugs: [network, network-bind]

    mongodb:
        command: mongodb-control
        daemon: simple
        plugs: [network, network-bind]

    help:
        command: wekan-help

    database-backup:
        command: mongodb-backup
        plugs: [network, network-bind]

    database-list-backups:
        command: ls -ald $SNAP_COMMON/db-backups/*

    database-restore:
        command: mongodb-restore
        plugs: [network, network-bind]

parts:
    mongodb:
        source: https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-ubuntu1604-3.4.3.tgz
        plugin: dump
        stage-packages: [libssl1.0.0]
        filesets:
            mongo:
                - usr
                - bin
                - lib
        stage:
            - $mongo
        prime:
            - $mongo

    wekan:
        source: .
        plugin: nodejs
        node-packages: [npm]
        node-engine: 4.8.1
        prepare: |
            curl https://install.meteor.com/ | sh
            rm -rf ~/.npm
            rm -rf /usr/local/lib/node_modules
            git submodule init
            git submodule update
            npm -g install n
            n 4.8.1
        build-packages:
            - python
            - g++
            - capnproto
            - nodejs
            - nodejs-legacy
            - curl
        build: |
            npm -g install npm@latest
            npm -g install node-gyp
            npm -g install node-pre-gyp
            npm -g install fibers
            npm install
            meteor build .build --directory --allow-superuser
            cp fix-download-unicode/cfs_access-point.txt .build/bundle/programs/server/packages/cfs_access-point.js
            sed -i "s|build\/Release\/bson|browser_build\/bson|g" .build/bundle/programs/server/npm/node_modules/meteor/cfs_gridfs/node_modules/mongodb/node_modules/bson/ext/index.js
            cd .build/bundle/programs/server/npm/node_modules/meteor/npm-bcrypt
            rm -rf node_modules/bcrypt
            npm install bcrypt
            cd ../../../../
            npm install
        install: |
            cp -r .build/bundle/* $SNAPCRAFT_PART_INSTALL/
            cp .build/bundle/.node_version.txt $SNAPCRAFT_PART_INSTALL/
        organize:
            README: README.wekan

    helpers:
        source: snap-src
        plugin: dump
        organize:
            wekan-control: bin/wekan-control
            mongodb-control: bin/mongodb-control
            wekan-read-settings: bin/wekan-read-settings
            wekan-help: bin/wekan-help
            mongodb-backup: bin/mongodb-backup
            mongodb-restore: bin/mongodb-restore
            config: bin/config
